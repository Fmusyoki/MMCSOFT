{% extends 'base.html' %}
{% block content %}
<div class="container py-4">

  <!-- üåü New Invoice Form -->
  <div class="card shadow-lg border-0 rounded-3 mb-5">
    <div class="card-header bg-primary text-white rounded-top">
      <h4 class="mb-0"><i class="bi bi-receipt me-2"></i> New Invoice</h4>
    </div>
    <div class="card-body p-4">
      <form id="invoiceForm" method="POST">
        {% csrf_token %}

        <div class="row g-3">
            <!-- Client -->
          <div class="col-md-6">
            <label for="client" class="form-label fw-semibold">Client</label>
            <input type="text" class="form-control" id="client" name="client" required>
          </div>
          <!-- Invoice ID -->
          <div class="col-md-6">
            <label for="invoice_id" class="form-label fw-semibold">Invoice Number</label>
            <input type="text" class="form-control" id="invoice_id" name="invoice_no" required>
          </div>
          <!-- Project -->
          <div class="col-md-6">
            <label for="project" class="form-label fw-semibold">Project</label>
            <input type="text" class="form-control" id="project" name="project" required>
          </div>
          <!-- Amount -->
          <div class="col-md-6">
            <label for="amount" class="form-label fw-semibold">Amount</label>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
          </div>

          <!-- Status -->
          <div class="col-md-6">
            <label for="status" class="form-label fw-semibold">Status</label>
            <select class="form-select" id="status" name="status" required>
            <option value="">-- Select Status --</option>
            <option value="fully_paid">Fully Paid</option>
            <option value="partially_paid">Partially Paid</option>
            <option value="overdue">Overdue</option>
            </select>
          </div>
          <!-- Due Date -->
          <div class="col-md-6">
            <label for="due_date" class="form-label fw-semibold">Due Date</label>
            <input type="date" class="form-control" id="due_date" name="due_date" required>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end mt-4">
          <button type="submit" class="btn btn-success px-4">
            <i class="bi bi-check-circle me-1"></i> Add Invoice
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- üåü Recent Invoices -->
  <div class="card shadow-lg border-0 rounded-3">
    <div class="card-header bg-light">
      <h4 class="mb-0 text-primary"><i class="bi bi-list-task me-2"></i> Recent Invoices</h4>
    </div>
    <div class="card-body p-4">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Client</th>
              <th>Invoice Number</th>
              <th>Project</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Due Date</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for invoice in invoices %}
            <tr>
              <td>{{ invoice.client }}</td>
              <td>{{ invoice.invoice_no  }}</td>
              <td>{{ invoice.project }}</td>
              <td>${{ invoice.amount }}</td>
              <td>
                <span class="badge 
                  {% if invoice.status == 'Fully Paid' %} bg-success
                  {% elif invoice.status == 'Partially Paid' %} bg-warning text-dark
                  {% else %} bg-danger {% endif %}">
                  {{ invoice.status }}
                </span>
              </td>
              <td>{{ invoice.due_date }}</td>
              <td class="text-center">
                <a href="#" class="btn btn-sm btn-outline-primary me-1">View</a>
                <a href="#" class="btn btn-sm btn-outline-secondary">Download</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No invoices found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- üåü Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="responseModalLabel">Submission Status</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="responseMessage"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("invoiceForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  try {
    const response = await fetch(form.action || window.location.href, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const data = await response.json();
    const responseModal = new bootstrap.Modal(document.getElementById("responseModal"));
    const responseMessage = document.getElementById("responseMessage");

    if (data.success) {
      responseMessage.innerHTML = `<div class="alert alert-success mb-0">‚úÖ Invoice added successfully!</div>`;
      form.reset();

      const tableBody = document.querySelector("table tbody");
      const emptyRow = tableBody.querySelector("tr td[colspan]");
      if (emptyRow) emptyRow.parentNode.remove();

      const newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td>${data.client}</td>
        <td>${data.invoice_no}</td>
        <td>${data.project}</td>
        <td>$${data.amount}</td>
        <td>
        <span class="badge ${
                data.status === "fully_paid" ? "bg-success" :
                data.status === "partially_paid" ? "bg-warning text-dark" : "bg-danger"
            }">${data.status === 'fully_paid' ? 'Fully Paid' : (data.status === 'partially_paid' ? 'Partially Paid' : 'Overdue')}</span>
        </td>
        <td>${data.due_date}</td>
        <td class="text-center">
          <a href="#" class="btn btn-sm btn-outline-primary me-1">View</a>
          <a href="#" class="btn btn-sm btn-outline-secondary">Download</a>
        </td>
      `;
      tableBody.appendChild(newRow);
    } else {
      responseMessage.innerHTML = `<div class="alert alert-danger mb-0">‚ùå ${data.error || "Invoice add failed."}</div>`;
    }
    responseModal.show();
  } catch (error) {
    document.getElementById("responseMessage").innerHTML =
      `<div class="alert alert-warning mb-0">‚ö†Ô∏è Error: ${error.message}</div>`;
    new bootstrap.Modal(document.getElementById("responseModal")).show();
  }
});
</script>

<style>
.card {
  border-radius: 12px;
}
.table thead th {
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85rem;
}
.table tbody td {
  vertical-align: middle;
}
.badge {
  font-size: 0.85rem;
  padding: 0.5em 0.75em;
  border-radius: 8px;
}
</style>
{% endblock %}
