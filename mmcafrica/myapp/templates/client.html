{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-4 text-primary">Add Client</h2>

  <form method="post" id="clientForm" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Client Name</label>
        <input type="text" name="client_name" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Year</label>
        <input type="date" name="client_year" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Project Name</label>
        <input type="text" name="project_name" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Contact Person</label>
        <input type="text" name="contact_person" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Phone</label>
        <input type="text" name="phone_number" class="form-control" required>
      </div>
      <div class="col-md-12">
        <label class="form-label">Contract</label>
        <input type="file" name="client_image" class="form-control" accept="image/*">
      </div>
    </div>
    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-success">Save</button>
      <a href="" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- search -->
 <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
  <input type="text" id="clientSearch" class="form-control w-100 w-md-50 fw-bold placeholder-bold" placeholder="Search clients">
</div>

<!-- Client List Table -->
<div class="container-fluid mt-5">
  <div class="card shadow-sm p-4">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle text-nowrap" id="clientTable">
        <thead class="table-primary">
          <tr>
            <th>No</th>
            <th>Client Name</th>
            <th>Year</th>
            <th>Project Name</th>
            <th>Contact Person</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Contract</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for client in clients %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              <a href="#" class="view-client text-decoration-none text-primary fw-bold"
                 data-id="{{ client.id }}">
                 {{ client.client_name }}
              </a>
            </td>
            <td>{{ client.client_year }}</td>
            <td class="text-truncate" style="max-width: 150px;">{{ client.project_name }}</td>
            <td>{{ client.contact_person }}</td>
            <td class="text-truncate" style="max-width: 180px;">{{ client.email }}</td>       
            <td>{{ client.phone_number }}</td> 
            <td>
              {% if client.client_image %}
                <a href="{{ client.client_image.url }}" target="_blank">View Contract</a>
              {% else %}
                <span class="text-muted">No file</span>
              {% endif %}
            </td>
            <td>
              <a href="" class="btn btn-sm btn-outline-primary">Edit</a>
              <a href="" class="btn btn-sm btn-outline-danger"
                 onclick="return confirm('Are you sure you want to delete this client?');">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted">No clients found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!--DOWNLOAD CLIENT LIST-->
<a href="{% url 'download_clients_csv' %}" class="btn btn-success">Download Clients CSV</a>
<!-- ✅ Modal for Viewing Client -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Client Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="clientDetails">
        <p class="text-muted">Loading...</p>
      </div>
    </div>
  </div>
</div>

<script>
// ✅ Save Client via AJAX
document.getElementById("clientForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  try {
    const response = await fetch(form.action || window.location.href, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const data = await response.json();
    if (data.success) {
      alert("✅ Client saved successfully!");
      location.reload();
    } else {
      alert("❌ Failed: " + (data.error || "Try again."));
    }
  } catch (error) {
    alert("⚠️ Error: " + error.message);
  }
});

// ✅ View Client Details in Modal
document.querySelectorAll(".view-client").forEach(link => {
  link.addEventListener("click", async function(e) {
    e.preventDefault();
    const clientId = this.getAttribute("data-id");

    try {
      const response = await fetch(`/clients/${clientId}/`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await response.json();

      if (data.success) {
        document.getElementById("clientDetails").innerHTML = `
          <ul class="list-group">
            <li class="list-group-item"><strong>Client Name:</strong> ${data.client.client_name}</li>
            <li class="list-group-item"><strong>Year:</strong> ${data.client.client_year}</li>
            <li class="list-group-item"><strong>Project Name:</strong> ${data.client.project_name}</li>
            <li class="list-group-item"><strong>Contact Person:</strong> ${data.client.contact_person}</li>
            <li class="list-group-item"><strong>Email:</strong> ${data.client.email}</li>
            <li class="list-group-item"><strong>Phone:</strong> ${data.client.phone_number}</li>
          </ul>
        `;
        new bootstrap.Modal(document.getElementById("clientModal")).show();
      } else {
        document.getElementById("clientDetails").innerHTML = `<div class="text-danger">Error loading client.</div>`;
      }
    } catch (error) {
      document.getElementById("clientDetails").innerHTML = `<div class="text-danger">⚠️ ${error.message}</div>`;
    }
  });
});

// Search filter for client list
document.getElementById("clientSearch").addEventListener("keyup", function() {
  const query = this.value.toLowerCase();
  const rows = document.querySelectorAll("#clientTable tbody tr");

  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(query) ? "" : "none";
  });
});



</script>
{% endblock %}
